

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Smart Contract Processing &mdash; hyperledger-fabricdocs master documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Application" href="application.html" />
    <link rel="prev" title="Process and Data Design" href="architecture.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          


          
            <a href="../index.html" class="icon icon-home"> hyperledger-fabricdocs
          

          
          </a>

          
            
            
              <div class="version">
                master
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          

<br><img style="background-color: #fff; height: unset; width: unset;" alt="Hyperledger Fabric" src=../_images/hyperledger_fabric_logo_color.png />
<br>
<a href="https://github.com/hyperledger/fabric"><img style="padding: 0px; margin: auto auto auto auto;" alt="GitHub" src="../_static/images/github_button.png"/></a>
&nbsp;<a href="https://stackoverflow.com/questions/tagged/hyperledger-fabric"><img style="padding: 0px; margin: auto auto auto auto;" alt="StackOverflow" src="../_static/images/stackoverflow_button.png"/></a>
&nbsp;<a href="https://chat.hyperledger.org"><img style="padding: 0px; margin: auto auto auto auto;" alt="Rocket Chat" src="../_static/images/rocketchat_button.png"/></a>
&nbsp;<a href="https://www.youtube.com/playlist?list=PL0MZ85B_96CH7wvtrRzV7SvtRY0sI0DEg"><img style="padding: 0px; margin: auto auto auto auto;" alt="Youtube Channel" src="../_static/images/youtube_button.png"/></a>

        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../whatis.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../whatsnew.html">What’s new in v1.4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../whatsnew.html#release-notes">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../key_concepts.html">Key Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="developing_applications.html">Developing Applications</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="scenario.html">The scenario</a></li>
<li class="toctree-l2"><a class="reference internal" href="analysis.html">Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html">Process and Data Design</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Smart Contract Processing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#smart-contract">Smart Contract</a></li>
<li class="toctree-l3"><a class="reference internal" href="#contract-class">Contract class</a></li>
<li class="toctree-l3"><a class="reference internal" href="#transaction-definition">Transaction definition</a></li>
<li class="toctree-l3"><a class="reference internal" href="#transaction-logic">Transaction logic</a></li>
<li class="toctree-l3"><a class="reference internal" href="#representing-an-object">Representing an object</a></li>
<li class="toctree-l3"><a class="reference internal" href="#access-the-ledger">Access the ledger</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="application.html">Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="apis.html">APIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="designelements.html">Application design elements</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ops_guide.html">Operations Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../command_ref.html">Commands Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture.html">Architecture Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Fabric-FAQ.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CONTRIBUTING.html">Contributions Welcome!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releases.html">Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../questions.html">Still Have Questions?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../status.html">Status</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">hyperledger-fabricdocs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="developing_applications.html">Developing Applications</a> &raquo;</li>
        
      <li>Smart Contract Processing</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/developapps/smartcontract.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="smart-contract-processing">
<h1>Smart Contract Processing<a class="headerlink" href="#smart-contract-processing" title="Permalink to this headline">¶</a></h1>
<p><strong>Audience</strong>: Architects, Application and smart contract developers</p>
<p>At the heart of a blockchain network is a smart contract. In PaperNet, the code
in the commercial paper smart contract defines the valid states for commercial
paper, and the transaction logic that transition a paper from one state to
another. In this topic, we’re going to show you how to implement a real world
smart contract that governs the process of issuing, buying and redeeming
commercial paper.</p>
<p>We’re going to cover:</p>
<ul class="simple">
<li><a class="reference external" href="#smart-contract">What is a smart contract and why it’s important</a></li>
<li><a class="reference external" href="#contract-class">How to define a smart contract</a></li>
<li><a class="reference external" href="#transaction-definition">How to define a transaction</a></li>
<li><a class="reference external" href="#transaction-logic">How to implement a transaction</a></li>
<li><a class="reference external" href="#representing-an-object">How to represent a business object in a smart contract</a></li>
<li><a class="reference external" href="#access-the-ledger">How to store and retrieve an object in the ledger</a></li>
</ul>
<p>If you’d like, you can <a class="reference external" href="../install.html">download the sample</a> and even <a class="reference external" href="../tutorial/commercial_paper.html">run it
locally</a>. It is written in JavaScript, but
the logic is quite language independent, so you’ll be easily able to see what’s
going on! (The sample will become available for Java and GOLANG as well.)</p>
<div class="section" id="smart-contract">
<h2>Smart Contract<a class="headerlink" href="#smart-contract" title="Permalink to this headline">¶</a></h2>
<p>A smart contract defines the different states of a business object and governs
the processes that move the object between these different states. Smart
contracts are important because they allow architects and smart contract
developers to define the key business processes and data that are shared across
the different organizations collaborating in a blockchain network.</p>
<p>In the PaperNet network, the smart contract is shared by the different network
participants, such as MagnetoCorp and DigiBank.  The same version of the smart
contract must be used by all applications connected to the network so that they
jointly implement the same shared business processes and data.</p>
</div>
<div class="section" id="contract-class">
<h2>Contract class<a class="headerlink" href="#contract-class" title="Permalink to this headline">¶</a></h2>
<p>A copy of the PaperNet commercial paper smart contract is contained in
<code class="docutils literal notranslate"><span class="pre">papercontract.js</span></code>. <a class="reference external" href="https://github.com/hyperledger/fabric-samples/blob/master/commercial-paper/organization/magnetocorp/contract/lib/papercontract.js">View
it</a>
with your browser, or open it in your favourite editor if you’ve downloaded it.</p>
<p>You may notice from the file path that this is MagnetoCorp’s copy of the smart
contract.  MagnetoCorp and DigiBank must agree the version of the smart contract
that they are going to use. For now, it doesn’t matter which organization’s copy
you look at, they are all the same.</p>
<p>Spend a few moments looking at the overall structure of the smart contract;
notice that it’s quite short! Towards the top of <code class="docutils literal notranslate"><span class="pre">papercontract.js</span></code>, you’ll see
that there’s a definition for the commercial paper smart contract:</p>
<div class="highlight-JavaScript notranslate"><div class="highlight"><pre><span></span><span class="kr">class</span> <span class="nx">CommercialPaperContract</span> <span class="kr">extends</span> <span class="nx">Contract</span> <span class="p">{...}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">CommercialPaperContract</span></code>
<a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Classes">class</a>
contains the transaction definitions for commercial paper – <strong>issue</strong>, <strong>buy</strong>
and <strong>redeem</strong>. It’s these transactions that bring commercial papers into
existence and move them through their lifecycle. We’ll examine these
<a class="reference external" href="#transaction-definition">transactions</a> soon, but for now notice how
<code class="docutils literal notranslate"><span class="pre">CommericalPaperContract</span></code> extends the Hyperledger Fabric <code class="docutils literal notranslate"><span class="pre">Contract</span></code>
<a class="reference external" href="https://fabric-shim.github.io/release-1.4/fabric-contract-api.Contract.html">class</a>.
This built-in class, and the <code class="docutils literal notranslate"><span class="pre">Context</span></code> class, were brought into scope earlier:</p>
<div class="highlight-JavaScript notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">Contract</span><span class="p">,</span> <span class="nx">Context</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fabric-contract-api&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>Our commercial paper contract will use built-in features of these classes, such
as automatic method invocation, a
<a class="reference external" href="./transactioncontext.html">per-transaction context</a>,
<a class="reference external" href="./transactionhandler.html">transaction handlers</a>, and class-shared state.</p>
<p>Notice also how the class constructor uses its
<a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/super">superclass</a>
to initialize itself with a <a class="reference external" href="./namespace.html">namespace</a>:</p>
<div class="highlight-JavaScript notranslate"><div class="highlight"><pre><span></span><span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="kr">super</span><span class="p">(</span><span class="s1">&#39;org.papernet.commercialpaper&#39;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Most importantly, <code class="docutils literal notranslate"><span class="pre">org.papernet.commercialpaper</span></code> is very descriptive – this smart
contract is the agreed definition of commercial paper for all PaperNet
organizations.</p>
<p>Usually there will only be one smart contract per file – contracts tend to have
different lifecycles, which makes it sensible to separate them. However, in some
cases, multiple smart contracts might provide syntactic help for applications,
e.g. <code class="docutils literal notranslate"><span class="pre">EuroBond</span></code>, <code class="docutils literal notranslate"><span class="pre">DollarBond</span></code>, <code class="docutils literal notranslate"><span class="pre">YenBond</span></code>, but essentially provide the same
function. In such cases, smart contracts and transactions can be disambiguated.</p>
</div>
<div class="section" id="transaction-definition">
<h2>Transaction definition<a class="headerlink" href="#transaction-definition" title="Permalink to this headline">¶</a></h2>
<p>Within the class, locate the <strong>issue</strong> method.</p>
<div class="highlight-JavaScript notranslate"><div class="highlight"><pre><span></span><span class="nx">async</span> <span class="nx">issue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">issuer</span><span class="p">,</span> <span class="nx">paperNumber</span><span class="p">,</span> <span class="nx">issueDateTime</span><span class="p">,</span> <span class="nx">maturityDateTime</span><span class="p">,</span> <span class="nx">faceValue</span><span class="p">)</span> <span class="p">{...}</span>
</pre></div>
</div>
<p>This function is given control whenever this contract is called to <code class="docutils literal notranslate"><span class="pre">issue</span></code> a
commercial paper. Recall how commercial paper 00001 was created with the
following transaction:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Txn</span> <span class="o">=</span> <span class="n">issue</span>
<span class="n">Issuer</span> <span class="o">=</span> <span class="n">MagnetoCorp</span>
<span class="n">Paper</span> <span class="o">=</span> <span class="mi">00001</span>
<span class="n">Issue</span> <span class="n">time</span> <span class="o">=</span> <span class="mi">31</span> <span class="n">May</span> <span class="mi">2020</span> <span class="mi">09</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">EST</span>
<span class="n">Maturity</span> <span class="n">date</span> <span class="o">=</span> <span class="mi">30</span> <span class="n">November</span> <span class="mi">2020</span>
<span class="n">Face</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">5</span><span class="n">M</span> <span class="n">USD</span>
</pre></div>
</div>
<p>We’ve changed the variable names for programming style, but see how these
properties map almost directly to the <code class="docutils literal notranslate"><span class="pre">issue</span></code> method variables.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">issue</span></code> method is automatically given control by the contract whenever an
application makes a request to issue a commercial paper. The transaction
property values are made available to the method via the corresponding
variables. See how an application submits a transaction using the Hyperledger
Fabric SDK in the <a class="reference external" href="./application.html">application</a> topic, using a sample
application program.</p>
<p>You might have noticed an extra variable in the <strong>issue</strong> definition – <code class="docutils literal notranslate"><span class="pre">ctx</span></code>.
It’s called the <a class="reference external" href="./transactioncontext.html"><strong>transaction context</strong></a>, and it’s
always first. By default, it maintains both per-contract and per-transaction
information relevant to <a class="reference external" href="#transaction-logic">transaction logic</a>. For example, it
would contain MagnetoCorp’s specified transaction identifier, a MagnetoCorp
issuing user’s digital certificate, as well as access to the ledger API.</p>
<p>See how the smart contract extends the default transaction context by
implementing its own <code class="docutils literal notranslate"><span class="pre">createContext()</span></code> method rather than accepting the
default implementation:</p>
<div class="highlight-JavaScript notranslate"><div class="highlight"><pre><span></span><span class="nx">createContext</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">CommercialPaperContext</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This extended context adds a custom property <code class="docutils literal notranslate"><span class="pre">paperList</span></code> to the defaults:</p>
<div class="highlight-JavaScript notranslate"><div class="highlight"><pre><span></span><span class="kr">class</span> <span class="nx">CommercialPaperContext</span> <span class="kr">extends</span> <span class="nx">Context</span> <span class="p">{</span>

  <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="kr">super</span><span class="p">();</span>
    <span class="c1">// All papers are held in a list of papers</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">paperList</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PaperList</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We’ll soon see how <code class="docutils literal notranslate"><span class="pre">ctx.paperList</span></code> can be subsequently used to help store and
retrieve all PaperNet commercial papers.</p>
<p>To solidify your understanding of the structure of a smart contract transaction,
locate the <strong>buy</strong> and <strong>redeem</strong> transaction definitions, and see if you can
see how they map to their corresponding commercial paper transactions.</p>
<p>The <strong>buy</strong> transaction:</p>
<div class="highlight-JavaScript notranslate"><div class="highlight"><pre><span></span><span class="nx">async</span> <span class="nx">buy</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">issuer</span><span class="p">,</span> <span class="nx">paperNumber</span><span class="p">,</span> <span class="nx">currentOwner</span><span class="p">,</span> <span class="nx">newOwner</span><span class="p">,</span> <span class="nx">price</span><span class="p">,</span> <span class="nx">purchaseTime</span><span class="p">)</span> <span class="p">{...}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Txn</span> <span class="o">=</span> <span class="n">buy</span>
<span class="n">Issuer</span> <span class="o">=</span> <span class="n">MagnetoCorp</span>
<span class="n">Paper</span> <span class="o">=</span> <span class="mi">00001</span>
<span class="n">Current</span> <span class="n">owner</span> <span class="o">=</span> <span class="n">MagnetoCorp</span>
<span class="n">New</span> <span class="n">owner</span> <span class="o">=</span> <span class="n">DigiBank</span>
<span class="n">Purchase</span> <span class="n">time</span> <span class="o">=</span> <span class="mi">31</span> <span class="n">May</span> <span class="mi">2020</span> <span class="mi">10</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">EST</span>
<span class="n">Price</span> <span class="o">=</span> <span class="mf">4.94</span><span class="n">M</span> <span class="n">USD</span>
</pre></div>
</div>
<p>The <strong>redeem</strong> transaction:</p>
<div class="highlight-JavaScript notranslate"><div class="highlight"><pre><span></span><span class="nx">async</span> <span class="nx">redeem</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">issuer</span><span class="p">,</span> <span class="nx">paperNumber</span><span class="p">,</span> <span class="nx">redeemingOwner</span><span class="p">,</span> <span class="nx">redeemDateTime</span><span class="p">)</span> <span class="p">{...}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Txn</span> <span class="o">=</span> <span class="n">redeem</span>
<span class="n">Issuer</span> <span class="o">=</span> <span class="n">MagnetoCorp</span>
<span class="n">Paper</span> <span class="o">=</span> <span class="mi">00001</span>
<span class="n">Redeemer</span> <span class="o">=</span> <span class="n">DigiBank</span>
<span class="n">Redeem</span> <span class="n">time</span> <span class="o">=</span> <span class="mi">31</span> <span class="n">Dec</span> <span class="mi">2020</span> <span class="mi">12</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">EST</span>
</pre></div>
</div>
<p>In both cases, observe the 1:1 correspondence between the commercial paper
transaction and the smart contract method definition.  And don’t worry about the
<code class="docutils literal notranslate"><span class="pre">async</span></code> and <code class="docutils literal notranslate"><span class="pre">await</span></code>
<a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function">keywords</a>
– they allow asynchronous JavaScript functions to be treated like their
synchronous cousins in other programming languages.</p>
</div>
<div class="section" id="transaction-logic">
<h2>Transaction logic<a class="headerlink" href="#transaction-logic" title="Permalink to this headline">¶</a></h2>
<p>Now that you’ve seen how contracts are structured and transactions are defined,
let’s focus on the logic within the smart contract.</p>
<p>Recall the first <strong>issue</strong> transaction:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Txn</span> <span class="o">=</span> <span class="n">issue</span>
<span class="n">Issuer</span> <span class="o">=</span> <span class="n">MagnetoCorp</span>
<span class="n">Paper</span> <span class="o">=</span> <span class="mi">00001</span>
<span class="n">Issue</span> <span class="n">time</span> <span class="o">=</span> <span class="mi">31</span> <span class="n">May</span> <span class="mi">2020</span> <span class="mi">09</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">EST</span>
<span class="n">Maturity</span> <span class="n">date</span> <span class="o">=</span> <span class="mi">30</span> <span class="n">November</span> <span class="mi">2020</span>
<span class="n">Face</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">5</span><span class="n">M</span> <span class="n">USD</span>
</pre></div>
</div>
<p>It results in the <strong>issue</strong> method being passed control:</p>
<div class="highlight-JavaScript notranslate"><div class="highlight"><pre><span></span><span class="nx">async</span> <span class="nx">issue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">issuer</span><span class="p">,</span> <span class="nx">paperNumber</span><span class="p">,</span> <span class="nx">issueDateTime</span><span class="p">,</span> <span class="nx">maturityDateTime</span><span class="p">,</span> <span class="nx">faceValue</span><span class="p">)</span> <span class="p">{</span>

   <span class="c1">// create an instance of the paper</span>
  <span class="kd">let</span> <span class="nx">paper</span> <span class="o">=</span> <span class="nx">CommercialPaper</span><span class="p">.</span><span class="nx">createInstance</span><span class="p">(</span><span class="nx">issuer</span><span class="p">,</span> <span class="nx">paperNumber</span><span class="p">,</span> <span class="nx">issueDateTime</span><span class="p">,</span> <span class="nx">maturityDateTime</span><span class="p">,</span> <span class="nx">faceValue</span><span class="p">);</span>

  <span class="c1">// Smart contract, rather than paper, moves paper into ISSUED state</span>
  <span class="nx">paper</span><span class="p">.</span><span class="nx">setIssued</span><span class="p">();</span>

  <span class="c1">// Newly issued paper is owned by the issuer</span>
  <span class="nx">paper</span><span class="p">.</span><span class="nx">setOwner</span><span class="p">(</span><span class="nx">issuer</span><span class="p">);</span>

  <span class="c1">// Add the paper to the list of all similar commercial papers in the ledger world state</span>
  <span class="nx">await</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">paperList</span><span class="p">.</span><span class="nx">addPaper</span><span class="p">(</span><span class="nx">paper</span><span class="p">);</span>

  <span class="c1">// Must return a serialized paper to caller of smart contract</span>
  <span class="k">return</span> <span class="nx">paper</span><span class="p">.</span><span class="nx">toBuffer</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The logic is simple: take the transaction input variables, create a new
commercial paper <code class="docutils literal notranslate"><span class="pre">paper</span></code>, add it to the list of all commercial papers using
<code class="docutils literal notranslate"><span class="pre">paperList</span></code>, and return the new commercial paper (serialized as a buffer) as the
transaction response.</p>
<p>See how <code class="docutils literal notranslate"><span class="pre">paperList</span></code> is retrieved from the transaction context to provide access
to the list of commercial papers. <code class="docutils literal notranslate"><span class="pre">issue()</span></code>, <code class="docutils literal notranslate"><span class="pre">buy()</span></code> and <code class="docutils literal notranslate"><span class="pre">redeem()</span></code> continually
re-access <code class="docutils literal notranslate"><span class="pre">ctx.paperList</span></code> to keep the list of commercial papers up-to-date.</p>
<p>The logic for the <strong>buy</strong> transaction is a little more elaborate:</p>
<div class="highlight-JavaScript notranslate"><div class="highlight"><pre><span></span><span class="nx">async</span> <span class="nx">buy</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">issuer</span><span class="p">,</span> <span class="nx">paperNumber</span><span class="p">,</span> <span class="nx">currentOwner</span><span class="p">,</span> <span class="nx">newOwner</span><span class="p">,</span> <span class="nx">price</span><span class="p">,</span> <span class="nx">purchaseDateTime</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// Retrieve the current paper using key fields provided</span>
  <span class="kd">let</span> <span class="nx">paperKey</span> <span class="o">=</span> <span class="nx">CommercialPaper</span><span class="p">.</span><span class="nx">makeKey</span><span class="p">([</span><span class="nx">issuer</span><span class="p">,</span> <span class="nx">paperNumber</span><span class="p">]);</span>
  <span class="kd">let</span> <span class="nx">paper</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">paperList</span><span class="p">.</span><span class="nx">getPaper</span><span class="p">(</span><span class="nx">paperKey</span><span class="p">);</span>

  <span class="c1">// Validate current owner</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">paper</span><span class="p">.</span><span class="nx">getOwner</span><span class="p">()</span> <span class="o">!==</span> <span class="nx">currentOwner</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Paper &#39;</span> <span class="o">+</span> <span class="nx">issuer</span> <span class="o">+</span> <span class="nx">paperNumber</span> <span class="o">+</span> <span class="s1">&#39; is not owned by &#39;</span> <span class="o">+</span> <span class="nx">currentOwner</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// First buy moves state from ISSUED to TRADING</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">paper</span><span class="p">.</span><span class="nx">isIssued</span><span class="p">())</span> <span class="p">{</span>
      <span class="nx">paper</span><span class="p">.</span><span class="nx">setTrading</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="c1">// Check paper is not already REDEEMED</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">paper</span><span class="p">.</span><span class="nx">isTrading</span><span class="p">())</span> <span class="p">{</span>
      <span class="nx">paper</span><span class="p">.</span><span class="nx">setOwner</span><span class="p">(</span><span class="nx">newOwner</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Paper &#39;</span> <span class="o">+</span> <span class="nx">issuer</span> <span class="o">+</span> <span class="nx">paperNumber</span> <span class="o">+</span> <span class="s1">&#39; is not trading. Current state = &#39;</span> <span class="o">+</span><span class="nx">paper</span><span class="p">.</span><span class="nx">getCurrentState</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="c1">// Update the paper</span>
  <span class="nx">await</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">paperList</span><span class="p">.</span><span class="nx">updatePaper</span><span class="p">(</span><span class="nx">paper</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">paper</span><span class="p">.</span><span class="nx">toBuffer</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>See how the transaction checks <code class="docutils literal notranslate"><span class="pre">currentOwner</span></code> and that <code class="docutils literal notranslate"><span class="pre">paper</span></code> is <code class="docutils literal notranslate"><span class="pre">TRADING</span></code>
before changing the owner with <code class="docutils literal notranslate"><span class="pre">paper.setOwner(newOwner)</span></code>. The basic flow is
simple though – check some pre-conditions, set the new owner, update the
commercial paper on the ledger, and return the updated commercial paper
(serialized as a buffer) as the transaction response.</p>
<p>Why don’t you see if you can understand the logic for the <strong>redeem</strong>
transaction?</p>
</div>
<div class="section" id="representing-an-object">
<h2>Representing an object<a class="headerlink" href="#representing-an-object" title="Permalink to this headline">¶</a></h2>
<p>We’ve seen how to define and implement the <strong>issue</strong>, <strong>buy</strong> and <strong>redeem</strong>
transactions using the <code class="docutils literal notranslate"><span class="pre">CommercialPaper</span></code> and <code class="docutils literal notranslate"><span class="pre">PaperList</span></code> classes. Let’s end
this topic by seeing how these classes work.</p>
<p>Locate the <code class="docutils literal notranslate"><span class="pre">CommercialPaper</span></code> class in the <code class="docutils literal notranslate"><span class="pre">paper.js</span></code>
<a class="reference external" href="https://github.com/hyperledger/fabric-samples/blob/master/commercial-paper/organization/magnetocorp/contract/lib/paper.js">file</a>:</p>
<div class="highlight-JavaScript notranslate"><div class="highlight"><pre><span></span><span class="kr">class</span> <span class="nx">CommercialPaper</span> <span class="kr">extends</span> <span class="nx">State</span> <span class="p">{...}</span>
</pre></div>
</div>
<p>This class contains the in-memory representation of a commercial paper state.
See how the <code class="docutils literal notranslate"><span class="pre">createInstance</span></code> method initializes a new commercial paper with the
provided parameters:</p>
<div class="highlight-JavaScript notranslate"><div class="highlight"><pre><span></span><span class="kr">static</span> <span class="nx">createInstance</span><span class="p">(</span><span class="nx">issuer</span><span class="p">,</span> <span class="nx">paperNumber</span><span class="p">,</span> <span class="nx">issueDateTime</span><span class="p">,</span> <span class="nx">maturityDateTime</span><span class="p">,</span> <span class="nx">faceValue</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">CommercialPaper</span><span class="p">({</span> <span class="nx">issuer</span><span class="p">,</span> <span class="nx">paperNumber</span><span class="p">,</span> <span class="nx">issueDateTime</span><span class="p">,</span> <span class="nx">maturityDateTime</span><span class="p">,</span> <span class="nx">faceValue</span> <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Recall how this class was used by the <strong>issue</strong> transaction:</p>
<div class="highlight-JavaScript notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nx">paper</span> <span class="o">=</span> <span class="nx">CommercialPaper</span><span class="p">.</span><span class="nx">createInstance</span><span class="p">(</span><span class="nx">issuer</span><span class="p">,</span> <span class="nx">paperNumber</span><span class="p">,</span> <span class="nx">issueDateTime</span><span class="p">,</span> <span class="nx">maturityDateTime</span><span class="p">,</span> <span class="nx">faceValue</span><span class="p">);</span>
</pre></div>
</div>
<p>See how every time the issue transaction is called, a new in-memory instance of
a commercial paper is created containing the transaction data.</p>
<p>A few important points to note:</p>
<ul>
<li><p class="first">This is an in-memory representation; we’ll see
<a class="reference external" href="#accessing-the-ledger">later</a> how it appears on the ledger.</p>
</li>
<li><p class="first">The <code class="docutils literal notranslate"><span class="pre">CommercialPaper</span></code> class extends the <code class="docutils literal notranslate"><span class="pre">State</span></code> class. <code class="docutils literal notranslate"><span class="pre">State</span></code> is an
application-defined class which creates a common abstraction for a state.
All states have a business object class which they represent, a composite
key, can be serialized and de-serialized, and so on.  <code class="docutils literal notranslate"><span class="pre">State</span></code> helps our code
be more legible when we are storing more than one business object type on
the ledger. Examine the <code class="docutils literal notranslate"><span class="pre">State</span></code> class in the <code class="docutils literal notranslate"><span class="pre">state.js</span></code>
<a class="reference external" href="https://github.com/hyperledger/fabric-samples/blob/master/commercial-paper/organization/magnetocorp/contract/ledger-api/state.js">file</a>.</p>
</li>
<li><p class="first">A paper computes its own key when it is created – this key will be used
when the ledger is accessed. The key is formed from a combination of
<code class="docutils literal notranslate"><span class="pre">issuer</span></code> and <code class="docutils literal notranslate"><span class="pre">paperNumber</span></code>.</p>
<div class="highlight-JavaScript notranslate"><div class="highlight"><pre><span></span><span class="nx">constructor</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">super</span><span class="p">(</span><span class="nx">CommercialPaper</span><span class="p">.</span><span class="nx">getClass</span><span class="p">(),</span> <span class="p">[</span><span class="nx">obj</span><span class="p">.</span><span class="nx">issuer</span><span class="p">,</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">paperNumber</span><span class="p">]);</span>
  <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">obj</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first">A paper is moved to the <code class="docutils literal notranslate"><span class="pre">ISSUED</span></code> state by the transaction, not by the paper
class. That’s because it’s the smart contract that governs the lifecycle
state of the paper. For example, an <code class="docutils literal notranslate"><span class="pre">import</span></code> transaction might create a new
set of papers immediately in the <code class="docutils literal notranslate"><span class="pre">TRADING</span></code> state.</p>
</li>
</ul>
<p>The rest of the <code class="docutils literal notranslate"><span class="pre">CommercialPaper</span></code> class contains simple helper methods:</p>
<div class="highlight-JavaScript notranslate"><div class="highlight"><pre><span></span><span class="nx">getOwner</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">owner</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Recall how methods like this were used by the smart contract to move the
commercial paper through its lifecycle. For example, in the <strong>redeem</strong>
transaction we saw:</p>
<div class="highlight-JavaScript notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nx">paper</span><span class="p">.</span><span class="nx">getOwner</span><span class="p">()</span> <span class="o">===</span> <span class="nx">redeemingOwner</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">paper</span><span class="p">.</span><span class="nx">setOwner</span><span class="p">(</span><span class="nx">paper</span><span class="p">.</span><span class="nx">getIssuer</span><span class="p">());</span>
  <span class="nx">paper</span><span class="p">.</span><span class="nx">setRedeemed</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="access-the-ledger">
<h2>Access the ledger<a class="headerlink" href="#access-the-ledger" title="Permalink to this headline">¶</a></h2>
<p>Now locate the <code class="docutils literal notranslate"><span class="pre">PaperList</span></code> class in the <code class="docutils literal notranslate"><span class="pre">paperlist.js</span></code>
<a class="reference external" href="https://github.com/hyperledger/fabric-samples/blob/master/commercial-paper/organization/magnetocorp/contract/lib/paperlist.js">file</a>:</p>
<div class="highlight-JavaScript notranslate"><div class="highlight"><pre><span></span><span class="kr">class</span> <span class="nx">PaperList</span> <span class="kr">extends</span> <span class="nx">StateList</span> <span class="p">{</span>
</pre></div>
</div>
<p>This utility class is used to manage all PaperNet commercial papers in
Hyperledger Fabric state database. The PaperList data structures are described
in more detail in the <a class="reference external" href="./architecture.html">architecture topic</a>.</p>
<p>Like the <code class="docutils literal notranslate"><span class="pre">CommercialPaper</span></code> class, this class extends an application-defined
<code class="docutils literal notranslate"><span class="pre">StateList</span></code> class which creates a common abstraction for a list of states – in
this case, all the commercial papers in PaperNet.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">addPaper()</span></code> method is a simple veneer over the <code class="docutils literal notranslate"><span class="pre">StateList.addState()</span></code>
method:</p>
<div class="highlight-JavaScript notranslate"><div class="highlight"><pre><span></span><span class="nx">async</span> <span class="nx">addPaper</span><span class="p">(</span><span class="nx">paper</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">addState</span><span class="p">(</span><span class="nx">paper</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can see in the <code class="docutils literal notranslate"><span class="pre">StateList.js</span></code>
<a class="reference external" href="https://github.com/hyperledger/fabric-samples/blob/master/commercial-paper/organization/magnetocorp/contract/ledger-api/statelist.js">file</a>
how the <code class="docutils literal notranslate"><span class="pre">StateList</span></code> class uses the Fabric API <code class="docutils literal notranslate"><span class="pre">putState()</span></code> to write the
commercial paper as state data in the ledger:</p>
<div class="highlight-JavaScript notranslate"><div class="highlight"><pre><span></span><span class="nx">async</span> <span class="nx">addState</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">key</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">stub</span><span class="p">.</span><span class="nx">createCompositeKey</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">getSplitKey</span><span class="p">());</span>
  <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">State</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">state</span><span class="p">);</span>
  <span class="nx">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">stub</span><span class="p">.</span><span class="nx">putState</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Every piece of state data in a ledger requires these two fundamental elements:</p>
<ul class="simple">
<li><strong>Key</strong>: <code class="docutils literal notranslate"><span class="pre">key</span></code> is formed with <code class="docutils literal notranslate"><span class="pre">createCompositeKey()</span></code> using a fixed name and
the key of <code class="docutils literal notranslate"><span class="pre">state</span></code>. The name was assigned when the <code class="docutils literal notranslate"><span class="pre">PaperList</span></code> object was
constructed, and <code class="docutils literal notranslate"><span class="pre">state.getSplitKey()</span></code> determines each state’s unique key.</li>
<li><strong>Data</strong>: <code class="docutils literal notranslate"><span class="pre">data</span></code> is simply the serialized form of the commercial paper
state, created using the <code class="docutils literal notranslate"><span class="pre">State.serialize()</span></code> utility method. The <code class="docutils literal notranslate"><span class="pre">State</span></code>
class serializes and deserializes data using JSON, and the State’s business
object class as required, in our case <code class="docutils literal notranslate"><span class="pre">CommercialPaper</span></code>, again set when the
<code class="docutils literal notranslate"><span class="pre">PaperList</span></code> object was constructed.</li>
</ul>
<p>Notice how a <code class="docutils literal notranslate"><span class="pre">StateList</span></code> doesn’t store anything about an individual state or the
total list of states – it delegates all of that to the Fabric state database.
This is an important design pattern – it reduces the opportunity for <a class="reference external" href="../readwrite.html">ledger
MVCC collisions</a> in Hyperledger Fabric.</p>
<p>The StateList <code class="docutils literal notranslate"><span class="pre">getState()</span></code> and <code class="docutils literal notranslate"><span class="pre">updateState()</span></code> methods work in similar ways:</p>
<div class="highlight-JavaScript notranslate"><div class="highlight"><pre><span></span><span class="nx">async</span> <span class="nx">getState</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">ledgerKey</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">stub</span><span class="p">.</span><span class="nx">createCompositeKey</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">State</span><span class="p">.</span><span class="nx">splitKey</span><span class="p">(</span><span class="nx">key</span><span class="p">));</span>
  <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">stub</span><span class="p">.</span><span class="nx">getState</span><span class="p">(</span><span class="nx">ledgerKey</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">State</span><span class="p">.</span><span class="nx">deserialize</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">supportedClasses</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">state</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-JavaScript notranslate"><div class="highlight"><pre><span></span><span class="nx">async</span> <span class="nx">updateState</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">key</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">stub</span><span class="p">.</span><span class="nx">createCompositeKey</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">getSplitKey</span><span class="p">());</span>
  <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">State</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">state</span><span class="p">);</span>
  <span class="nx">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">stub</span><span class="p">.</span><span class="nx">putState</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>See how they use the Fabric APIs <code class="docutils literal notranslate"><span class="pre">putState()</span></code>, <code class="docutils literal notranslate"><span class="pre">getState()</span></code> and
<code class="docutils literal notranslate"><span class="pre">createCompositeKey()</span></code> to access the ledger. We’ll expand this smart contract
later to list all commercial papers in paperNet – what might the method look
like to implement this ledger retrieval?</p>
<p>That’s it! In this topic you’ve understood how to implement the smart contract
for PaperNet.  You can move to the next sub topic to see how an application
calls the smart contract using the Fabric SDK.</p>
<!--- Licensed under Creative Commons Attribution 4.0 International License
https://creativecommons.org/licenses/by/4.0/ --></div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="application.html" class="btn btn-neutral float-right" title="Application" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="architecture.html" class="btn btn-neutral" title="Process and Data Design" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Hyperledger 2019.
    <br>
      <br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>
      <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
        <img alt="Creative Commons License" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>